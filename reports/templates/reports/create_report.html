{% extends 'base.html' %} {% load static %}

<!-- Styles -->
{% block page_styles %}
<style>
  .bootstrap-select button.dropdown-toggle {
    background: none;
  }

  .flatpickr-wrapper {
    display: block !important;
  }

  .reportWizard .bs-stepper-content {
    max-width: 800px;
  }

  div#id_accident_scenarios {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-gap: 0.7rem 1.2rem;
    padding-top: 0.5rem;
  }

  #id_accident_scenarios > div > label {
    display: flex;
    gap: 0.5rem;
  }

  .wizardFormField {
    margin-bottom: 1.2rem;
  }

  .wizardFormField.hide {
    display: none;
  }

  .light-style .bs-stepper .bs-stepper-header .step:not(.active) .bs-stepper-subtitle,
  .bs-stepper .bs-stepper-header .step .step-trigger .bs-stepper-label .bs-stepper-subtitle {
    white-space: normal !important;
    word-break: break-word;
  }

  div#witness-form .form-control {
    width: auto;
  }

  .dropzone {
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .dropzone.bg-light {
    background-color: #f8f9fa !important;
    border-color: #696cff !important;
  }

  .dropzone-wrapper {
    position: relative;
  }

  .dropzone-input {
    opacity: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    z-index: 2;
  }

  .uploadLine .imageContainer {
    width: 33%;
  }

  .uploadLine .imageContainer img {
    width: 100%;
  }
</style>

<!-- signature pad stylings -->
<style>
  #signature-pad {
    border: 1px solid #ced4da; /* Wie andere Inputs */
    border-radius: 4px; /* Wie andere Inputs */
    background-color: #fff;
    cursor: crosshair;
    touch-action: none; /* Wichtig für Touch-Geräte */
    width: 100%; /* Nimm die volle Breite ein */
    height: 200px; /* Passe die Höhe an */
    display: block; /* Verhindert extra Platz unter dem Canvas */
  }

  .signature-button-group {
    margin-top: 10px;
    display: flex;
    gap: 10px;
  }
</style>
{% endblock page_styles %}

<!-- Page Skripts -->
{% block page_scripts %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const wizardNumbered = document.querySelector(".reportWizard"),
      wizardNumberedBtnNextList = [].slice.call(wizardNumbered.querySelectorAll(".btn-next")),
      wizardNumberedBtnPrevList = [].slice.call(wizardNumbered.querySelectorAll(".btn-prev")),
      wizardNumberedBtnSubmit = wizardNumbered.querySelector(".btn-submit");

    if (typeof wizardNumbered !== undefined && wizardNumbered !== null) {
      const numberedStepper = new Stepper(wizardNumbered, {
        linear: false,
      });
      if (wizardNumberedBtnNextList) {
        wizardNumberedBtnNextList.forEach((wizardNumberedBtnNext) => {
          wizardNumberedBtnNext.addEventListener("click", (event) => {
            numberedStepper.next();
          });
        });
      }
      if (wizardNumberedBtnPrevList) {
        wizardNumberedBtnPrevList.forEach((wizardNumberedBtnPrev) => {
          wizardNumberedBtnPrev.addEventListener("click", (event) => {
            numberedStepper.previous();
          });
        });
      }
      if (wizardNumberedBtnSubmit) {
        wizardNumberedBtnSubmit.addEventListener("click", (event) => {
          alert("Submitted..!!");
        });
      }
    }
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var flatpickrDateTime = document.querySelector("#flatpickr-datetime");

    flatpickrDateTime.flatpickr({
      enableTime: true,
      dateFormat: "d.m.Y H:i",
      static: false,
      locale: "de", // Dies ist korrekt
      time_24hr: true,
    });
  });
</script>

<!-- Remove form-check-input from multiple select  -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var formCheckInputs = document.querySelectorAll("div > div.form-check-input");

    formCheckInputs.forEach((element) => {
      element.classList.remove("form-check-input");
    });
  });
</script>

<!-- Autosize textfield -->
<script>
  const textarea = document.querySelectorAll("textarea");
  textarea.forEach((element) => {
    autosize(element);
  });
</script>

<!-- Show/hide fields scripts -->
<script>
  function toggleFieldVisibility(field, state) {
    // Extract parent formField
    let parentFormField = field.closest("div.wizardFormField");

    if (state == "show") {
      parentFormField.classList.remove("hide");
    } else {
      parentFormField.classList.add("hide");
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Extract person_or_company select field
    const person_or_company = document.querySelector("#id_person_or_company");

    // Extract checkbook_exists field
    const checkbook_exists = document.querySelector("#id_checkbook_exists");

    // if person_or_company
    if (person_or_company) {
      // Extract company name field
      let company_name_field = document.querySelector("#id_company_name");

      // If company is selected, show company name field
      if (person_or_company.value == "company") {
        toggleFieldVisibility(company_name_field, "show");
      } else {
        toggleFieldVisibility(company_name_field, "hide");
      }

      person_or_company.addEventListener("change", function () {
        // If company is selected, show company name field
        if (person_or_company.value == "company") {
          toggleFieldVisibility(company_name_field, "show");
        } else {
          toggleFieldVisibility(company_name_field, "hide");
        }
      });
    }
    // endif person_or_company

    // if checkbook_exists
    if (checkbook_exists) {
      // Extract checkbook upload field
      let checkbook_upload_field = document.querySelector("#id_checkbook");

      // If checkbook_exists field is checked show upload field
      if (checkbook_exists.checked) {
        toggleFieldVisibility(checkbook_upload_field, "show");
      } else {
        toggleFieldVisibility(checkbook_upload_field, "hide");
      }

      checkbook_exists.addEventListener("change", function () {
        // If company is selected, show company name field
        if (checkbook_exists.checked) {
          toggleFieldVisibility(checkbook_upload_field, "show");
        } else {
          toggleFieldVisibility(checkbook_upload_field, "hide");
        }
      });
    }
    // endif checkbook_exists
  });
</script>

<!-- Signature Pad -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Überprüfen, ob SignaturePad geladen wurde
    if (typeof SignaturePad === "undefined") {
      console.error("SignaturePad konnte nicht geladen werden!");
      return;
    }

    const canvas = document.getElementById("signature-pad");
    const clearButton = document.getElementById("clear-signature-button");
    // Das versteckte Eingabefeld, das von Django für 'signature_base64' generiert wird
    const signatureDataInput = document.getElementById("id_signature_base64");

    if (!canvas) {
      console.error('Canvas-Element mit ID "signature-pad" nicht gefunden.');
      return;
    }
    // Wenn der Clear-Button nicht da ist, ist das nicht kritisch für das reine Zeichnen.
    if (!clearButton) {
      console.warn('Button-Element mit ID "clear-signature-button" nicht gefunden.');
    }
    // Das versteckte Feld ist für das reine Zeichnen auch nicht primär, wird aber beim Löschen geleert.
    if (!signatureDataInput) {
      console.warn('Verstecktes Eingabefeld "id_signature_base64" nicht gefunden.');
    }

    const signaturePad = new SignaturePad(canvas, {
      backgroundColor: "rgb(255, 255, 255)", // Weißer Hintergrund
      penColor: "rgb(0, 0, 0)", // Schwarze Stiftfarbe
    });

    // Funktion zum Anpassen der Canvas-Größe
    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);

      // Wichtig: Das Canvas muss eine definierte offsetWidth/offsetHeight haben (durch CSS)
      // damit dies funktioniert.
      if (canvas.offsetWidth === 0 || canvas.offsetHeight === 0) {
        console.warn("#signature-pad hat keine definierte Breite/Höhe durch CSS. Setze Standardwerte.");
        // Fallback, falls CSS nicht greift oder das Element noch nicht sichtbar ist.
        // Diese Werte sollten Sie an Ihr Design anpassen.
        canvas.style.width = "400px";
        canvas.style.height = "200px";
      }

      // Physische Pixel des Canvas setzen
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;

      // CSS-Pixel (Anzeigegröße) beibehalten
      canvas.style.width = canvas.offsetWidth + "px";
      canvas.style.height = canvas.offsetHeight + "px";

      // Kontext für High-DPI skalieren
      canvas.getContext("2d").scale(ratio, ratio);

      // Nach einer Größenänderung ist der Inhalt des Canvas leer.
      // Wenn Daten im signatureDataInput wären, könnte man versuchen, sie neu zu zeichnen:
      // if (signatureDataInput && signatureDataInput.value) {
      //     signaturePad.fromDataURL(signatureDataInput.value);
      // } else {
      //     signaturePad.clear();
      // }
      // Fürs Erste einfach löschen:
      signaturePad.clear();
    }

    // Canvas initial anpassen. Ein kleiner Timeout kann helfen,
    // falls CSS-Dimensionen nicht sofort beim DOMContentLoaded verfügbar sind.
    setTimeout(resizeCanvas, 100);

    // Optional: Bei Fenstergrößenänderung erneut anpassen.
    // ACHTUNG: Dies löscht die aktuelle Zeichnung. Nur aktivieren, wenn wirklich nötig.
    // window.addEventListener('resize', resizeCanvas);

    // Event Listener für den "Löschen"-Button
    if (clearButton) {
      clearButton.addEventListener("click", function () {
        signaturePad.clear();
        if (signatureDataInput) {
          signatureDataInput.value = ""; // Verstecktes Feld leeren
        }
      });
    }

    // **WICHTIG für den nächsten Schritt (Datenübertragung):**
    // Um die Daten beim Absenden des Formulars in das Feld 'id_signature_base64' zu bekommen,
    // benötigen Sie einen Event Listener für das Formular-Submit-Ereignis.
    // Das lassen wir hier, wie gewünscht, erstmal weg.
    // Beispiel (für später):
    /*
    const form = canvas.closest('form');
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!signaturePad.isEmpty()) {
                if (signatureDataInput) {
                    signatureDataInput.value = signaturePad.toDataURL('image/png');
                }
            } else {
                if (signatureDataInput) {
                    signatureDataInput.value = '';
                }
            }
        });
    }
    */
  });
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC7KR7tSiM_BfzUc8MfGC0WADHVFH8XdNE&libraries=places&callback=initAutocomplete" async defer></script>

<script>
  function initAutocomplete() {
    // Feld 1: Adresse
    const addressInput = document.getElementById("id_address");
    const addressAutocomplete = new google.maps.places.Autocomplete(addressInput, {
      fields: ["address_components", "geometry", "icon", "name"],
    });

    // Feld 2: Unfallort
    const accidentInput = document.getElementById("id_accident_location");
    const accidentAutocomplete = new google.maps.places.Autocomplete(accidentInput, {
      // Hier könntest du andere Optionen festlegen, falls nötig
      // z.B. die Suche auf Deutschland beschränken
      componentRestrictions: { country: "de" },
      fields: ["address_components", "geometry", "icon", "name"],
    });

    // Optional: Event-Listener für das Adressfeld
    addressAutocomplete.addListener("place_changed", () => {
      const place = addressAutocomplete.getPlace();
      console.log("Ausgewählte Adresse:", place);
    });

    // Optional: Event-Listener für das Unfallort-Feld
    accidentAutocomplete.addListener("place_changed", () => {
      const place = accidentAutocomplete.getPlace();
      console.log("Ausgewählter Unfallort:", place);
    });
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Checkbox und Witness-UI
    const witnessCheckbox = document.getElementById("id_has_witnesses");
    const witnessTextfield = document.getElementById("id_witness_textfield");

    let witnessUI = null;
    let witnesses = [];

    function updateWitnessTextfield() {
      // Synchronisiere die unsichtbare Textarea für das Backend
      if (witnessTextfield) {
        witnessTextfield.value = witnesses.map((w) => [w.name, w.address, w.phone].filter(Boolean).join(" | ")).join("\n");
      }
    }

    function renderWitnessList() {
      const listDiv = document.getElementById("witness-list");
      if (!listDiv) return;
      listDiv.innerHTML = "";
      witnesses.forEach((w, idx) => {
        const entry = document.createElement("div");
        entry.className = "witness-entry mb-1";
        entry.innerHTML = `
          <span><b>${w.name || "-"}</b> | ${w.address || "-"} | ${w.phone || "-"}</span>
          <button type="button" class="btn btn-sm btn-outline-secondary ms-2 edit-witness-btn" data-idx="${idx}">Bearbeiten</button>
          <button type="button" class="btn btn-sm btn-outline-danger ms-1 remove-witness-btn" data-idx="${idx}">Entfernen</button>
        `;
        listDiv.appendChild(entry);
      });
    }

    function createWitnessUI() {
      if (witnessUI) return witnessUI;
      witnessUI = document.createElement("div");
      witnessUI.id = "witness-ui";
      witnessUI.innerHTML = `
        <div id="witness-list" class="mt-2"></div>
        <div id="witness-form" style="display:none; margin-bottom:1rem;">
          <div class="d-flex gap-2 align-items-end flex-wrap">
            <input type="text" class="form-control mb-0" id="witness-name" placeholder="Name des Zeugen" style="min-width: 160px;">
            <input type="text" class="form-control mb-0" id="witness-address" placeholder="Adresse" style="min-width: 180px;">
            <input type="text" class="form-control mb-0" id="witness-phone" placeholder="Telefonnummer" style="min-width: 140px;">
            <button type="button" class="btn btn-primary" id="confirm-witness-btn">Bestätigen</button>
            <button type="button" class="btn btn-outline-secondary ms-2" id="cancel-witness-btn" style="display:none;">Abbrechen</button>
          </div>
        </div>
        <button type="button" class="btn btn-secondary mb-2" id="add-witness-btn">Zeuge hinzufügen</button>
      `;

      // ENTER-Handler für witness-form
      setTimeout(() => {
        const witnessForm = witnessUI.querySelector("#witness-form");
        if (witnessForm) {
          witnessForm.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
              e.preventDefault();
              document.getElementById("confirm-witness-btn").click();
            }
          });
        }
      }, 0);

      return witnessUI;
    }

    function showWitnessUI(show) {
      const checkboxDiv = witnessCheckbox.closest(".wizardFormField");
      if (show) {
        if (!document.getElementById("witness-ui")) {
          checkboxDiv.parentNode.insertBefore(createWitnessUI(), checkboxDiv.nextSibling);
        }
        renderWitnessList();
      } else {
        if (document.getElementById("witness-ui")) {
          document.getElementById("witness-ui").remove();
        }
      }
    }

    let editIndex = null;

    if (witnessCheckbox) {
      witnessCheckbox.addEventListener("change", function () {
        showWitnessUI(this.checked);
      });
      showWitnessUI(witnessCheckbox.checked);
    }

    document.body.addEventListener("click", function (e) {
      // Zeuge hinzufügen
      if (e.target && e.target.id === "add-witness-btn") {
        document.getElementById("witness-form").style.display = "block";
        document.getElementById("witness-name").value = "";
        document.getElementById("witness-address").value = "";
        document.getElementById("witness-phone").value = "";
        document.getElementById("cancel-witness-btn").style.display = "none";
        editIndex = null;
      }
      // Zeuge bestätigen (neu oder bearbeitet)
      if (e.target && e.target.id === "confirm-witness-btn") {
        const name = document.getElementById("witness-name").value.trim();
        const address = document.getElementById("witness-address").value.trim();
        const phone = document.getElementById("witness-phone").value.trim();
        if (!name && !address && !phone) return;
        if (editIndex !== null) {
          witnesses[editIndex] = { name, address, phone };
          editIndex = null;
        } else {
          witnesses.push({ name, address, phone });
        }
        updateWitnessTextfield();
        renderWitnessList();
        document.getElementById("witness-form").style.display = "none";
      }
      // Zeuge entfernen
      if (e.target && e.target.classList.contains("remove-witness-btn")) {
        const idx = parseInt(e.target.getAttribute("data-idx"));
        witnesses.splice(idx, 1);
        updateWitnessTextfield();
        renderWitnessList();
      }
      // Zeuge bearbeiten
      if (e.target && e.target.classList.contains("edit-witness-btn")) {
        const idx = parseInt(e.target.getAttribute("data-idx"));
        const w = witnesses[idx];
        document.getElementById("witness-name").value = w.name;
        document.getElementById("witness-address").value = w.address;
        document.getElementById("witness-phone").value = w.phone;
        document.getElementById("witness-form").style.display = "block";
        document.getElementById("cancel-witness-btn").style.display = "inline-block";
        editIndex = idx;
      }
      // Abbrechen
      if (e.target && e.target.id === "cancel-witness-btn") {
        document.getElementById("witness-form").style.display = "none";
        editIndex = null;
      }
    });
  });
</script>

<script>
  function previewDropzoneImage(input, previewId) {
    const preview = document.getElementById(previewId);
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(input.files[0]);
    } else {
      preview.src = "#";
      preview.style.display = "none";
    }
  }

  // Dropzone-Click auf das Input weiterleiten
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".dropzone").forEach(function (dropzone) {
      dropzone.addEventListener("click", function () {
        const input = this.parentNode.querySelector(".dropzone-input");
        if (input) input.click();
      });
      // Drag & Drop Support
      dropzone.addEventListener("dragover", function (e) {
        e.preventDefault();
        this.classList.add("bg-light");
      });
      dropzone.addEventListener("dragleave", function (e) {
        e.preventDefault();
        this.classList.remove("bg-light");
      });
      dropzone.addEventListener("drop", function (e) {
        e.preventDefault();
        this.classList.remove("bg-light");
        const input = this.parentNode.querySelector(".dropzone-input");
        if (input && e.dataTransfer.files.length) {
          input.files = e.dataTransfer.files;
          input.dispatchEvent(new Event("change"));
        }
      });
    });
  });
</script>
{% endblock page_scripts %}

<!-- tab titles -->
{% block tab_title %}Aufträge{% endblock tab_title %}

<!-- Content -->
{% block content %}

<div class="bs-stepper vertical wizard-modern wizard-modern-vertical-icons-example mt-6 reportWizard">
  <!-- wizard navigation -->
  <div class="bs-stepper-header">
    <!-- wizard step: basicData -->
    <div class="step" data-target="#basicData">
      <button type="button" class="step-trigger" aria-selected="false">
        <span class="bs-stepper-circle">
          <i class="icon-base bx bx-detail"></i>
        </span>
        <span class="bs-stepper-label">
          <span class="bs-stepper-title">Basisdaten</span>
          <span class="bs-stepper-subtitle">Persönliche Informationen</span>
        </span>
      </button>
    </div>
    <!-- /wizard step -->

    <!-- wizard step: details -->
    <div class="step" data-target="#details">
      <button type="button" class="step-trigger" aria-selected="false">
        <span class="bs-stepper-circle">
          <i class="icon-base bx bx-detail"></i>
        </span>
        <span class="bs-stepper-label">
          <span class="bs-stepper-title">Fahrzeug- & Bankdaten</span>
          <span class="bs-stepper-subtitle">Daten zum Fahrzeug und zur Bankverbindung</span>
        </span>
      </button>
    </div>
    <!-- /wizard step -->

    <!-- wizard step: accidentCause  -->
    <div class="step" data-target="#accidentCause">
      <button type="button" class="step-trigger" aria-selected="false">
        <span class="bs-stepper-circle">
          <i class="icon-base bx bxl-instagram"></i>
        </span>
        <span class="bs-stepper-label">
          <span class="bs-stepper-title">Unfallhergang</span>
          <span class="bs-stepper-subtitle">Angaben zum Unfallhergang und Zeugen</span>
        </span>
      </button>
    </div>
    <!-- wizard step -->

    <!-- wizard step: vehicleImages -->
    <div class="step" data-target="#vehicleImages">
      <button type="button" class="step-trigger" aria-selected="false">
        <span class="bs-stepper-circle">
          <i class="icon-base bx bx-camera"></i>
        </span>
        <span class="bs-stepper-label">
          <span class="bs-stepper-title">Fahrzeugbilder</span>
          <span class="bs-stepper-subtitle">Bilder hochladen</span>
        </span>
      </button>
    </div>
    <!-- /wizard step -->
  </div>
  <!-- / wizard navigation -->

  <!-- wizard content -->
  <div class="bs-stepper-content">
    <!-- form -->
    <form onSubmit="return false">
      <!-- Step 1 -->
      <div id="basicData" class="content">
        <!-- step header -->
        <div class="content-header mb-4">
          <h6 class="mb-0">Basisdaten</h6>
          <small>Füllen Sie Ihre persönlichen Angaben aus.</small>
        </div>
        <!-- / step header -->

        {% for field in report_form_step_1 %}

        <!-- if checkbox test -->
        {% if field.widget_type == "checkbox" %}
        <div class="wizardFormField d-flex align-items-center gap-2">
          {{field}}
          <label class="form-label m-0" for="id_{{field.name}}">{{field.label}}</label>
        </div>

        {% elif field.name == 'signature_base64' %}
        <div class="wizardFormField">
          <div class="signature-container">
            <label class="form-label m-0" for="id_{{field.name}}">Unterschrift</label>
            <div>
              <canvas id="signature-pad"></canvas>
              {{ field }}
            </div>
            <div class="signature-button-group">
              <button class="btn btn-label-primary" type="button" id="clear-signature-button">Löschen</button>
            </div>
          </div>
        </div>

        {% else %}

        <!-- field -->
        <div class="wizardFormField">
          <label class="form-label" for="id_{{field.name}}">{{field.label}}</label>
          {{field}}
        </div>

        {% endif %}
        <!-- endif checkbox test -->

        {% endfor %}

        <!-- step buttons -->
        <div class="col-12 d-flex justify-content-between mt-6">
          <button class="btn btn-primary btn-prev" disabled>
            <i class="icon-base bx bx-left-arrow-alt me-sm-2 me-0 scaleX-n1-rtl"></i>
            <span class="align-middle d-sm-inline-block d-none">Zurück</span>
          </button>
          <button class="btn btn-primary btn-next">
            <span class="align-middle d-sm-inline-block d-none me-sm-2">Weiter</span>
            <i class="icon-base bx bx-right-arrow-alt scaleX-n1-rtl"></i>
          </button>
        </div>
        <!-- / step buttons -->
      </div>
      <!-- / Step 1 -->

      <!-- Step 2 -->
      <div id="details" class="content">
        <!-- step header -->
        <div class="content-header mb-4">
          <h6 class="mb-0">Details</h6>
          <small>Bitte tragen Sie die Fahrzeug- und Zahlungsdaten ein.</small>
        </div>
        <!-- / step header -->

        {% for field in report_form_step_2 %}

        <!-- if checkbox test -->
        {% if field.widget_type == "checkbox" %}
        <div class="wizardFormField d-flex align-items-center gap-2">
          {{field}}
          <label class="form-label m-0" for="id_{{field.name}}">{{field.label}}</label>
        </div>

        {% else %}

        <!-- field -->
        <div class="wizardFormField">
          <label class="form-label" for="id_{{field.name}}">{{field.label}}</label>
          {{field}}
        </div>

        {% endif %}
        <!-- endif checkbox test -->

        {% endfor %}

        <!-- step buttons -->
        <div class="col-12 d-flex justify-content-between mt-6">
          <button class="btn btn-primary btn-prev">
            <i class="icon-base bx bx-left-arrow-alt me-sm-2 me-0 scaleX-n1-rtl"></i>
            <span class="align-middle d-sm-inline-block d-none">Zurück</span>
          </button>
          <button class="btn btn-primary btn-next">
            <span class="align-middle d-sm-inline-block d-none me-sm-2">Weiter</span>
            <i class="icon-base bx bx-right-arrow-alt scaleX-n1-rtl"></i>
          </button>
        </div>
        <!-- / step buttons -->
      </div>
      <!-- / Step 2 -->

      <!-- Step 3 -->
      <div id="accidentCause" class="content">
        <!-- step header -->
        <div class="content-header mb-4">
          <h6 class="mb-0">Unfallhergang</h6>
          <small>Geben Sie Details zum Unfall und zu Zeugen an.</small>
        </div>
        <!-- / step header -->

        {% for field in report_form_step_3 %}

        <!-- if checkbox test -->
        {% if field.widget_type == "checkbox" %}
        <div class="wizardFormField d-flex align-items-center gap-2">
          {{field}}
          <label class="form-label m-0" for="id_{{field.name}}">{{field.label}}</label>
        </div>

        {% else %}

        <!-- field -->
        <div class="wizardFormField">
          <label class="form-label" for="id_{{field.name}}">{{field.label}}</label>
          {{field}}
        </div>

        {% endif %}
        <!-- endif checkbox test -->

        {% endfor %}

        <!-- step buttons -->
        <div class="col-12 d-flex justify-content-between mt-6">
          <button class="btn btn-primary btn-prev">
            <i class="icon-base bx bx-left-arrow-alt me-sm-2 me-0 scaleX-n1-rtl"></i>
            <span class="align-middle d-sm-inline-block d-none">Zurück</span>
          </button>
          <button class="btn btn-primary btn-next">
            <span class="align-middle d-sm-inline-block d-none me-sm-2">Weiter</span>
            <i class="icon-base bx bx-right-arrow-alt scaleX-n1-rtl"></i>
          </button>
        </div>
        <!-- / step buttons -->
      </div>
      <!-- / Step 3 -->

      <!-- Step 4 -->
      <div id="vehicleImages" class="content">
        <div class="content-header mb-4">
          <h6 class="mb-0">Fahrzeugbilder hochladen</h6>
          <small>Bitte laden Sie Bilder Ihres Fahrzeugs aus den folgenden Ansichten hoch:</small>
        </div>
        {% for field in report_form_step_4 %}
        <div class="wizardFormField mb-4 row align-items-center">
          <div class="col">
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            <div class="d-flex align-items-center gap-3 uploadLine">
              <div class="flex-grow-1 dropzone-wrapper" style="position: relative">
                <input
                  type="file"
                  name="{{ field.name }}"
                  id="{{ field.id_for_label }}"
                  class="dropzone-input"
                  accept="image/*"
                  style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer"
                  onchange="previewDropzoneImage(this, 'preview-{{ field.name }}')" />
                <div class="dropzone border border-2 border-dashed rounded p-3 text-center" style="min-height: 120px">
                  <i class="bx bx-cloud-upload fs-1 mb-2"></i>
                  <p class="mb-0">Datei hier ablegen oder klicken zum Hochladen</p>
                  <img id="preview-{{ field.name }}" src="#" alt="Vorschau" style="display: none; max-width: 100%; max-height: 100px; margin-top: 10px" />
                </div>
              </div>
              <div class="text-center imageContainer">
                <img src="{% static 'img/vehicle_views/' %}{{ field.name }}.jpeg" alt="Beispiel {{ field.label }}" class="img-fluid border rounded" style="object-fit: contain" />
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        <div class="col-12 d-flex justify-content-between mt-6">
          <button class="btn btn-primary btn-prev">
            <i class="icon-base bx bx-left-arrow-alt me-sm-2 me-0 scaleX-n1-rtl"></i>
            <span class="align-middle d-sm-inline-block d-none">Zurück</span>
          </button>
          <button class="btn btn-primary btn-next">
            <span class="align-middle d-sm-inline-block d-none me-sm-2">Weiter</span>
            <i class="icon-base bx bx-right-arrow-alt scaleX-n1-rtl"></i>
          </button>
        </div>
      </div>
      <!-- / Step 4 -->
    </form>
    <!--  -->
  </div>
  <!-- wizard content -->
</div>
{% endblock content %}
